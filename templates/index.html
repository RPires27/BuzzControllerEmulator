<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0"
    />
    <title>Buzz! Controller</title>
    <style>
      /* Basic Resets and Body Styling */
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background-color: #1f1f1f;
        color: #f0f0f0;
        touch-action: manipulation;
      }

      /* Fullscreen toggle button */
      .fullscreen-toggle {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 40px;
        height: 40px;
        background-color: rgba(68, 68, 68, 0.8);
        border: none;
        border-radius: 8px;
        color: #f0f0f0;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
        z-index: 1000;
      }

      .fullscreen-toggle:hover {
        background-color: rgba(85, 85, 85, 0.9);
      }

      .fullscreen-toggle:active {
        transform: scale(0.95);
      }

      /* Main container to center everything */
      .controller-container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-evenly;
        align-items: center;
        padding: 20px;
      }

      /* Player Selector Styling */
      .player-selector-container {
        width: 100%;
        text-align: center;
        margin-bottom: 15px;
      }

      .player-selector-container label {
        font-size: 1.2em;
        margin-bottom: 10px;
        display: block;
      }

      .player-selector {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }

      .player-button {
        width: 45px;
        height: 45px;
        font-size: 1.2em;
        font-weight: bold;
        border-radius: 8px;
        border: 2px solid #555;
        background-color: #444;
        color: #fff;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .player-button.locked {
        background-color: #2a2a2a;
        color: #777;
        cursor: not-allowed;
        border-color: #333;
      }

      .player-button.selected {
        background-color: #007bff;
        border-color: #0056b3;
        transform: scale(1.1);
        box-shadow: 0 0 10px rgba(0, 123, 255, 0.7);
      }

      /* Big Red "Buzz" Button */
      .buzz-button-container {
        width: 60vmin;
        height: 60vmin;
        max-width: 250px;
        max-height: 250px;
      }

      .buzz-button {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 5px solid #c00;
        background: linear-gradient(145deg, #ff4d4d, #d60000);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
        font-size: 8vmin;
        color: white;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        cursor: pointer;
        transition: transform 0.05s ease;
      }

      /* Container for the four smaller color buttons */
      .color-buttons-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 70vmin;
        max-width: 300px;
      }

      .color-button {
        width: 100%;
        padding-bottom: 25%; /* Aspect ratio for wide buttons */
        height: 0;
        position: relative;
        border-radius: 15px;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        transition: transform 0.05s ease;
      }

      /* Giving each button its color */
      #blue {
        background-color: #007bff;
      }
      #orange {
        background-color: #fd7e14;
      }
      #green {
        background-color: #28a745;
      }
      #yellow {
        background-color: #ffc107;
      }

      /* Pressed state for all buttons */
      .buzz-button:active,
      .color-button:active {
        transform: scale(0.95);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
      }
    </style>
  </head>
  <body>
    <button
      class="fullscreen-toggle"
      onclick="toggleFullscreen()"
      title="Toggle Fullscreen"
    >
      ⛶
    </button>
    <div class="controller-container">
      <div class="player-selector-container">
        <label>Select Your Player</label>
        <div class="player-selector" id="player-selector">
          <!-- Player buttons will be generated by JavaScript -->
        </div>
      </div>

      <div class="buzz-button-container" onclick="buzz('red')">
        <button class="buzz-button">BUZZ</button>
      </div>

      <div class="color-buttons-container">
        <div id="blue" class="color-button" onclick="buzz('blue')"></div>
        <div id="orange" class="color-button" onclick="buzz('orange')"></div>
        <div id="green" class="color-button" onclick="buzz('green')"></div>
        <div id="yellow" class="color-button" onclick="buzz('yellow')"></div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
      const socket = io();
      let selectedPlayer = null;
      let mySid = null;

      // --- Player Selection ---
      const playerSelector = document.getElementById("player-selector");

      function createPlayerButtons() {
        playerSelector.innerHTML = ""; // Clear existing buttons
        for (let i = 1; i <= 8; i++) {
          const button = document.createElement("div");
          button.classList.add("player-button");
          button.dataset.player = i;
          button.textContent = i;
          button.addEventListener("click", () => selectPlayer(i));
          playerSelector.appendChild(button);
        }
      }

      function selectPlayer(player) {
        // If the button is locked by another player, do nothing
        const button = document.querySelector(`.player-button[data-player='${player}']`);
        if (button.classList.contains('locked') && !button.classList.contains('selected')) {
            return;
        }
        
        // Emit the player selection to the server
        socket.emit("select_player", { player: player });
      }

      socket.on("connect", () => {
        mySid = socket.id;
        createPlayerButtons(); // Initial creation
      });

      socket.on("update_players", (lockedPlayers) => {
        selectedPlayer = null; // Reset current selection
        const allPlayerButtons = document.querySelectorAll(".player-button");

        allPlayerButtons.forEach((button) => {
          const playerId = button.dataset.player;
          const lockingSid = lockedPlayers[playerId];

          // Reset styles
          button.classList.remove("locked", "selected");

          if (lockingSid) {
            if (lockingSid === mySid) {
              // This client has locked this player
              button.classList.add("selected");
              selectedPlayer = playerId; // Update the selected player
            } else {
              // Another client has locked this player
              button.classList.add("locked");
            }
          }
        });
      });

      // --- Buzz Action ---
      function buzz(color) {
        if (!selectedPlayer) {
          alert("Please select a player first!");
          return;
        }
        socket.emit("buzz", { player: selectedPlayer, color: color });
      }

      // --- Fullscreen Logic ---
      function toggleFullscreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(err => {
            console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
          });
        } else {
          document.exitFullscreen();
        }
      }

      document.addEventListener("fullscreenchange", updateFullscreenButton);
      function updateFullscreenButton() {
        const button = document.querySelector(".fullscreen-toggle");
        button.innerHTML = document.fullscreenElement ? "⛶" : "⛶";
        button.title = document.fullscreenElement ? "Exit Fullscreen" : "Enter Fullscreen";
      }

      // Initial setup
      createPlayerButtons();

    </script>
  </body>
</html>
